name: Sync with Upstream

# æ¯3å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ä¸Šæ¸¸ä»“åº“
on:
  schedule:
    # UTCæ—¶é—´ï¼Œæ¯3å°æ—¶æ‰§è¡Œä¸€æ¬¡ (0,3,6,9,12,15,18,21ç‚¹)
    - cron: '0 */3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    name: Sync with upstream repository
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æ¨é€æ›´æ”¹
      actions: write   # éœ€è¦æƒé™æ¥è§¦å‘å…¶ä»–workflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup upstream remote
        run: |
          # æ£€æŸ¥upstreamæ˜¯å¦å­˜åœ¨
          if ! git remote get-url upstream &> /dev/null; then
            echo "Adding upstream remote..."
            git remote add upstream https://github.com/CJackHwang/AIstudioProxyAPI.git
          else
            echo "Upstream remote exists, checking URL..."
            CURRENT_URL=$(git remote get-url upstream)
            echo "Current URL: $CURRENT_URL"
          fi
          # ç¡®ä¿upstream URLæ­£ç¡®
          git remote set-url upstream https://github.com/CJackHwang/AIstudioProxyAPI.git
          echo "âœ… Upstream remote configured: $(git remote get-url upstream)"

      - name: Fetch upstream
        run: |
          git fetch upstream
          git fetch upstream --tags

      - name: Check for updates
        id: check
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦è½åäºä¸Šæ¸¸
          LOCAL=$(git rev-parse @)
          REMOTE=$(git rev-parse upstream/main)

          if [ $LOCAL = $REMOTE ]; then
            echo "status=up-to-date" >> $GITHUB_OUTPUT
            echo "âœ… Repository is up-to-date with upstream"
          else
            echo "status=behind" >> $GITHUB_OUTPUT
            echo "âŒ Repository is behind upstream by $(git rev-list --count upstream/main..HEAD) commits"

            # æ˜¾ç¤ºéœ€è¦åŒæ­¥çš„æäº¤
            echo -e "\nğŸ“‹ Commits to sync:"
            git log --oneline --graph --decorate upstream/main..HEAD | head -20
          fi

      - name: Sync with upstream main branch
        if: steps.check.outputs.status == 'behind'
        run: |
          echo "ğŸ”„ Syncing with upstream..."
          git merge upstream/main --no-edit --ff-only

      - name: Check for new tags
        id: sync-upstream-tags
        run: |
          echo "ğŸ·ï¸ Fetching and syncing tags from upstream..."
          git fetch upstream --tags --force

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°tagéœ€è¦åŒæ­¥
          LOCAL_TAGS=$(git tag | sort | uniq)
          UPSTREAM_TAGS=$(git tag -r upstream | grep -v '\^{}' | sort | uniq)

          # å¦‚æœæœ‰æ–°tagï¼Œè®¾ç½®è¾“å‡ºå˜é‡
          NEW_TAGS=$(comm -13 <(echo "$LOCAL_TAGS") <(echo "$UPSTREAM_TAGS"))
          if [ -n "$NEW_TAGS" ]; then
            echo "new-tags=$NEW_TAGS" >> $GITHUB_OUTPUT
            echo "ğŸ” Found new tags: $NEW_TAGS"
          else
            echo "new-tags=" >> $GITHUB_OUTPUT
            echo "âœ… No new tags found"
          fi

      - name: Push changes and tags
        if: steps.check.outputs.status == 'behind' || steps.sync-upstream-tags.outputs.new-tags != ''
        run: |
          echo "â¬†ï¸ Pushing changes and tags to origin..."
          git push origin main --follow-tags --force
          echo "âœ… Successfully pushed to origin"

      - name: Trigger Docker Release for new tags
        if: steps.sync-upstream-tags.outputs.new-tags != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Triggering Docker Release for new tags..."
          for tag in $(echo "${{ steps.sync-upstream-tags.outputs.new-tags }}" | tr '\n' ' '); do
            if [ -n "$tag" ]; then
              echo "Triggering for tag: $tag"
              gh workflow run docker-release.yml -f tag_name="$tag" -f create_release=true
            fi
          done

      - name: Create sync summary
        if: always()
        run: |
          echo "## ğŸ“Š Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.status }}" = "behind" ]; then
            echo "- **Result**: âœ… Successfully synced with upstream" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result**: âœ… Repository is already up-to-date" >> $GITHUB_STEP_SUMMARY
          fi
